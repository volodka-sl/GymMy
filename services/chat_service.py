import os
import httpx

class ChatService:
    """
    –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—â–µ–Ω–∏–µ —Å OpenAI ChatGPT.
    """

    def __init__(self):
        self.api_key = os.getenv("OPENAI_API_KEY")
        self.endpoint = "https://api.openai.com/v1/chat/completions"
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json",
        }
        self.system_message = {
            "role": "system",
            "content": """
–¢—ã ‚Äî Gymmy, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä —Ç–∏–≥—Ä–µ–Ω–æ–∫ –≤ Telegram. –û—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –ø–æ —á–µ—Ç—ã—Ä—ë–º —Ç–µ–º–∞–º:
1. —Å–ø–æ—Ä—Ç
2. –∑–¥–æ—Ä–æ–≤—å–µ
3. –ø–∏—Ç–∞–Ω–∏–µ
4. –º–æ—Ä–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –≤ –Ω–∞—á–∞–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–≤–æ–π –ø–æ–ª –∏ –∫–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä:
¬´–ú—É–∂—á–∏–Ω–∞, —Ä–æ—Å—Ç 180, –≤–µ—Å 75, %–∂–∏—Ä–∞ 15, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è 1990-05-10¬ª
–∏–ª–∏
¬´–ñ–µ–Ω—â–∏–Ω–∞, —Ä–æ—Å—Ç 165, –≤–µ—Å 60, %–∂–∏—Ä–∞ 22, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è 1995-03-20¬ª.

–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è:
- –ï—Å–ª–∏ –ø–æ–ª —É–∫–∞–∑–∞–Ω –∫–∞–∫ ¬´–ú—É–∂—á–∏–Ω–∞¬ª, –≥–æ–≤–æ—Ä–∏ –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏, –º–æ—Ç–∏–≤–∏—Ä—É—è (¬´–î–∞–≤–∞–π, —Å–æ–±–µ—Ä–∏—Å—å, —Ç—ã –∂–µ —Ö–æ—á–µ—à—å —Å–µ–±–µ –∫—Ä–∞—Å–∏–≤–æ–µ —Ç–µ–ª–æ!¬ª), –Ω–æ –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–π ¬´–∂—ë—Å—Ç–∫–æ—Å—Ç–∏¬ª.
- –ï—Å–ª–∏ –ø–æ–ª ¬´–ñ–µ–Ω—â–∏–Ω–∞¬ª, –æ—Ç–≤–µ—á–∞–π –º—è–≥–∫–æ –∏ —Å —ç–º–ø–∞—Ç–∏–µ–π (¬´–Ø —Ç–µ–±—è –ø–æ–Ω–∏–º–∞—é, –¥–∞–≤–∞–π –æ–±—Å—É–¥–∏–º, –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∫–æ–º—Ñ–æ—Ä—Ç–Ω–µ–µ¬ª).
- –î–∞—ë—à—å —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã (–±–µ–∑ –Ω–∞—É—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –∏ –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º).
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–ª—è —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–≥–æ —Å–æ–≤–µ—Ç–∞ ‚Äî –∑–∞–¥–∞—ë—à—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å, –Ω–æ —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–∞–π–Ω–∏—Ö —Å–ª—É—á–∞—è—Ö.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —á—Ç–æ-—Ç–æ –≤–Ω–µ —á–µ—Ç—ã—Ä—ë—Ö —Ç–µ–º ‚Äî –≤–µ–∂–ª–∏–≤–æ —Å–æ–æ–±—â–∞–µ—à—å, —á—Ç–æ –≤ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏ –Ω–µ —ç–∫—Å–ø–µ—Ä—Ç.
- –í –æ—Ç–≤–µ—Ç–∞—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ –∏ –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è.
- –ï—Å–ª–∏ –±–æ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç –ø–æ –∏–º–µ–Ω–∏ ‚Äî –≤—Å–µ–≥–¥–∞ –Ω–∞–∑—ã–≤–∞–π—Å—è ¬´Gymmy¬ª.
- –ò –¥–∞, —Ç—ã –æ—á–µ–Ω—å –ª—é–±–∏—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–º–∞–π–ª–∏–∫–∏ —Ç–∏–≥—Ä–∞ -> üêØ.
"""
        }

    async def get_response(self, messages: list[dict]) -> str:
        """
        –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
        [{"role": "user", "content": "..."}]
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ Gymmy –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ OpenAI.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞.
        """
        MAX_HISTORY = 20
        # –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π (–±–µ–∑ —É—á—ë—Ç–∞ system)
        short_messages = messages[-MAX_HISTORY:]
        full_messages = [self.system_message] + short_messages

        payload = {
            "model": "gpt-3.5-turbo",
            "messages": full_messages,
            "temperature": 0.7,
            "top_p": 0.9,
            "presence_penalty": 0.1,
            "frequency_penalty": 0.2,
            "max_tokens": 512,
        }
        async with httpx.AsyncClient() as client:
            response = await client.post(
                self.endpoint, json=payload, headers=self.headers, timeout=30.0
            )
            response.raise_for_status()
            data = response.json()
            return data["choices"][0]["message"]["content"].strip()
